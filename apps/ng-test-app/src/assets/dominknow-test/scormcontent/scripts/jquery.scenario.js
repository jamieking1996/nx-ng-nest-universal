/*! -- File: jquery.scenario.js ( Input 0 ) -- */
!function(c){var d=function(a,b){this.options=b;this.messageFeed=new e;this.$el=c(a).addClass("scenario "+b.outline.parameters.config.orientation);this.initDB(b.outline);this.onWindowResize=DKI.func.debounce(c.proxy(this.sceneWindowResize,this),50,!1);this.skipAudio=!this.options.audioOn;this.initHandlers();this.loadBaseState();this.setHeight();this.audioControls=this.audioControls();this.getElementCharacterSetUrl();this.started=!1;this.path=[];return this};d.DEFAULTS={accessible:!0,audioOn:!0,backgroundAsset:"",
characterBaseUrl:"",strings:{audioPlay:"",audioStop:"",scenarioStart:"Play"},listeners:{onScore:function(){}}};d.constant=Object.freeze({screenReader:{visible:{tabindex:"1","aria-hidden":"false"},hidden:{tabindex:"-1","aria-hidden":"true"}}});d.prototype={initDB:function(a){this.db=function(){var a={},b={dragdrop_id:{}};return{store:function(c){a[c.id]=c;"scenarioOption"!==c.elementtype&&(b.dragdrop_id[c.dragdrop_id]=a[c.id])},get:function(b){return a[b]},getByKey:function(a,c){return b[a][c]},remove:function(b){delete a[item.id]},
clear:function(){a={}},getLength:function(){return Object.keys(a).length}}}();var b=c.proxy(function(a){this.db.store(a);for(var c in a.elements)b(a.elements[c])},this);b(a)},start:function(a){this.started||(a?this.loadFirstScene(this.options.startScene?this.db.get(this.options.startScene):this.options.outline,!1,!this.options.audioOn):this.showPreamble(c.proxy(function(a,c){this.loadFirstScene(this.options.startScene?this.db.get(this.options.startScene):this.options.outline,a,c)},this)),this.started=
!0)},stop:function(){this.audioControls.haltPlayback()},loadBaseState:function(){this.$el.find(".sb-bg")[0]||this.$el.append("\x3cdiv class\x3d'sb-bg"+(this.options.outline.parameters.config.blur?" blur":"")+"' style\x3d\"background-image:url('"+this.options.backgroundAsset+"')\"\x3e\x3c/div\x3e")},initHandlers:function(){var a=this;this.$el.on("click.scenario",".scene.interact .responses .sceneOption",function(){if(a.currentScene.isActive()){a.buildPath(a.currentScene.outline);if(c(this).data("id")){var b=
a.db.get(c(this).data("id"));b.elements[0]&&(a.currentScene.sceneDOM.removeClass("interact"),a.currentScene.active=!1,c(this).attr(d.constant.screenReader.hidden).siblings().attr(d.constant.screenReader.hidden),a.loadScene(b.elements[0],this))}else c(this).data("link")&&(a.messageFeed.clear(),a.currentScene.active=!1,c(this).attr(d.constant.screenReader.hidden).siblings().attr(d.constant.screenReader.hidden),a.loadScene(a.db.getByKey("dragdrop_id",c(this).data("link")),this));a.currentScene.optionSelected(this)}});
this.$el.on("click",".speech .audio .control",function(){var b=c(this).hasClass("fa-stop");c(this).removeClass("fa-stop fa-play").addClass(b?"fa-play":"fa-stop").attr("aria-checked",!b).attr("aria-label",b?a.options.strings.audioPlay:a.options.strings.audioStop);b?a.audioControls.haltPlayback():a.audioControls.play(a.db.get(c(this).closest(".speech").data("id")))});c(window).on("resize",this.onWindowResize)},destroy:function(){this.$el.off("scenario");delete this.db;c(window).off("resize",this.onWindowResize)},
loadFirstScene:function(a,b,h){if(this.options.outline.upload_id&&!h){var f=this;this.$el.append("\x3cdiv role\x3d'button' tabindex\x3d'1' aria-hidden\x3d'false' aria-label\x3d'"+this.options.strings.scenarioStart+"' class\x3d'clickStart disabler' style\x3d'display:block'\x3e\x3cdiv class\x3d'fa fa-play'\x3e\x3c/div\x3e\x3c/div\x3e").find(".clickStart").one("click",function(){c(this).remove();f.$el.find(".audio-control").attr(d.constant.screenReader.visible);f.loadScene(a,!1,b)})}else this.$el.find(".audio-control").attr(d.constant.screenReader.visible),
this.loadScene(a,!1,b)},loadScene:function(a,b,h){var f=this,g=function(){f.currentScene&&f.currentScene.hideOptions();var a=function(){f.currentScene=m.start(function(){f.currentScene&&f.currentScene.end()})};if(b&&c(b).hasClass("speech")){var h=f.db.get(c(b).data("id")),g=c(b).clone();g.html("\x3cspan tabindex\x3d'1' aria-hidden\x3d'false'\x3e"+g.html()+"\x3c/span\x3e").attr(d.constant.screenReader.hidden);d.Scene.Utility.checkHasAudio(h)&&g.prepend("\x3cdiv class\x3d'audio'\x3e\x3cdiv tabindex\x3d'1' role\x3d'switch' aria-checked\x3d'true' aria-label\x3d'"+
f.options.strings.audioStop+"' class\x3d'control fa fa-stop'\x3e\x3c/div\x3e\x3c/div\x3e");f.messageFeed.add(g,function(b){f.audioControls.load(h,function(b){setTimeout(a,!1===b?350:0)});d.Scene.Utility.checkHasAudio(h)&&g.find(".control")[0].focus()})}else a()},e=h?function(){h(g)}:g,m=(new d[a.parameters.config.endScene?"EndScene":"Scene"](a,this,this.$el)).render(e)},reset:function(){this.currentScene&&(this.currentScene.destroy(),delete this.currentScene);this.loadBaseState();this.messageFeed.clear();
this.clearPath();this.started=!1},sceneWindowResize:function(){this.messageFeed.resize();this.setHeight();this.$el[768>=this.$el.outerWidth()?"addClass":"removeClass"]("xs");this.currentScene&&this.currentScene.resize()},setHeight:function(){this.options.responsive?this.$el.css("min-height","calc(100vh - "+parseInt(c("body").css("margin-top").replace("px"),10)+"px)"):this.$el.css("min-height","calc(100% - "+parseInt(c("body").css("margin-top").replace("px"),10)+"px)")},getElementCharacterSetUrl:function(a,
b){var c=!1,d=this.options.characterBaseUrl;this.options.outline.asset_collection_id&&(a="undefined"===typeof a?"default":a,c=d+("/"+this.options.outline.asset_collection_id+"/"),a&&(c+=a+(b?"_headshot":"")+".png"));return c},showPreamble:function(a){if(!this.options.outline.txt||this.options.startScene&&this.options.startScene!=this.options.outline.id){var b=this.options.startScene?this.db.get(this.options.startScene):this.options.outline;a(!1,b.upload_id&&this.options.audioOn?!1:!0)}else{this.$el.append("\x3cdiv class\x3d'disabler flex flexCol' style\x3d'opacity:1;'\x3e\x3cdiv class\x3d'preamble flex flexCol' style\x3d'margin:auto'\x3e\x3cimg src\x3d'"+
this.getElementCharacterSetUrl(this.options.outline.parameters.config.emotion,!0)+"'/\x3e\x3cdiv tabindex\x3d'1' class\x3d'preamble_content flexAuto'\x3e"+this.options.outline.txt+"\x3c/div\x3e\x3cdiv tabindex\x3d'1' role\x3d'button' class\x3d'btn btn-primary'\x3e"+this.options.strings.scenarioStart+"\x3c/div\x3e\x3c/div\x3e\x3c/div\x3e");var c=this.$el.find(".disabler");a(function(a){c.find(".btn").on("click",function(){c.remove();a()})},!0)}},setScore:function(a){this.options.listeners.onScore(a)},
audioControls:function(a){a="player_"+this.options.outline.id;var b,d=!1,f=this;this.$el.append(Handlebars.compile('\x3cdiv id\x3d"{{audioSimpleAncestorId}}" class\x3d"jp-basic jPlayerAudioSimple"\x3e\x3cdiv class\x3d"jp-type-single"\x3e\x3cdiv id\x3d\'{{audioSimplePlayerId}}\' class\x3d"jp-audio"\x3e\x3c/div\x3e\x3cdiv class\x3d"jp-gui jp-basic jp-interface"\x3e\x3cdiv class\x3d"jp-controls-holder"\x3e\x3c/div\x3e\x3c/div\x3e\x3c/div\x3e\x3c/div\x3e')({audioSimpleAncestorId:a+"_ancestor",audioSimplePlayerId:a}));
b=this.$el.find("#"+a).jPlayer({cssSelectorAncestor:"#"+a+"_ancestor",ready:function(a){d=!0},loop:!1,preload:"auto",solution:"html",muted:!1,volume:1});var g=null,e={load:function(a,e){e=e||function(){};if(!a.upload_id||f.skipAudio)return e(!1),!1;var l=DKI.renderService.getAssetUrl({id:a.upload_id,folderId:a.asset_uploadfolderid,extension:a.asset_extension}),k=function(){b.one(c.jPlayer.event.loadeddata,function(){b.jPlayer("play");if("function"===typeof e)b.one(c.jPlayer.event.ended,e)});var d=
{};d[a.asset_extension]=l;b.jPlayer("setMedia",d);g=a};if(d)k();else b.one(c.jPlayer.event.ready,k);return!0},haltPlayback:function(){d&&(b.jPlayer("stop"),b.trigger(c.jPlayer.event.ended))},pause:function(){d&&b.jPlayer("pause")},play:function(a){d&&(!a||g&&g.id==a.id?b.jPlayer("play"):e.load(a))}};return{load:e.load,haltPlayback:e.haltPlayback,play:e.play}},buildPath:function(a){this.path.push({path:this.getScenePath(a).join("."),id:a.id})},clearPath:function(){this.path=[]},getScenePath:function(a){var b=
this,c=function(a,d){return a.parent_element_id?(a=b.db.get(a.parent_element_id),d.push(a.elementno),c(b.db.get(a.parent_element_id),d)):d.reverse()};return c(a,[])}};d.Scene=function(a,b,c){this.container=c;this.outline=a;this.scenario=b;this.messageFeed=b.messageFeed;this.active=!1;return this};d.Scene.prototype={render:function(a){var b=this.template||d.Scene.template,h=!0,f=new DKI.func.Queue,g=this,e=function(){"undefined"!==typeof objectFitImages&&objectFitImages(g.sceneDOM.find(".character .full"));
a()};this.sceneDOM=c(b(this.getRenderConfig()));this.container.append(this.sceneDOM);f.queue({name:"loadFinished",callback:e});this.sceneDOM.find("img").each(function(){c(this).prop("complete")||(h=!1,c(this).uniqueId(),f.queue({name:"loadFinished",id:c(this).attr("id")}),c(this).on("load error",function(){f.dequeue({name:"loadFinished",id:c(this).attr("id")})}))});h&&setTimeout(e,0);return this},getRenderConfig:function(){return{scene:this.outline,scenario:this.scenario.options.outline,speechOrientation:"left"==
this.scenario.options.outline.parameters.config.orientation?"right":"left",character:this.scenario.getElementCharacterSetUrl(this.outline.parameters.config.emotion),characterHeadshot:this.scenario.getElementCharacterSetUrl(this.outline.parameters.config.emotion,!0),strings:this.scenario.options.strings}},start:function(a){var b=this.scenario.options.outline.parameters.config;this.sceneDOM.attr(d.constant.screenReader.hidden);this.active=!0;this.messageFeed.attach(this.sceneDOM.find(".feedCont"),"prepend");
var e=[b.characterSpeechBubbleCls,b.characterSpeechBubbleBg,b.orientation];this.isResponded()&&e.push("top");var f=c.proxy(function(a){this.sceneDOM.addClass("interact");this.sceneDOM.find(".responses .speech, .responses .btn.btn-primary").attr(d.constant.screenReader.visible);return!1},this),b=c.proxy(function(a){this.syncElementPositions();this.sceneDOM.attr("aria-hidden","false");this.runStartingAudio(this instanceof d.EndScene?f():f);this.scenario.options.accessible&&(a=a?a.find(".speech *[tabindex]").first()[0]:
this.sceneDOM.find(".responses *[tabindex\x3d1]").first()[0]||this.container.closest(".dki-authoring-element").find("*[tabindex\x3d1]").first()[0])&&a.focus()},this);this.outline.meta?(e=c("\x3cdiv data-id\x3d'"+this.outline.id+"' class\x3d'speech characterSpeech "+e.join(" ")+"'\x3e\x3cspan tabindex\x3d'1'\x3e"+this.outline.meta+"\x3c/span\x3e\x3c/div\x3e"),d.Scene.Utility.checkHasAudio(this.outline)&&e.prepend("\x3cdiv class\x3d'audio'\x3e\x3cdiv tabindex\x3d'1' role\x3d'switch' aria-checked\x3d'true' aria-label\x3d'"+
this.scenario.options.strings.audioStop+"' class\x3d'control fa fa-stop'\x3e\x3c/div\x3e\x3c/div\x3e"),this.messageFeed.add(e,b),a&&a()):(a&&a(),b());this.messageFeed.setSyncEl(this.getCharacterEl());this.sceneDOM.addClass("active");return this},runStartingAudio:function(a){this.scenario.audioControls.load(this.outline,a)||"function"!==typeof a?!1:a()},end:function(a){this.sceneDOM.removeClass("active");this.sceneDOM.remove()},optionSelected:function(a){this.scenario.$el.trigger("scenario.optionSelected",
this.getSelectionData(a))},getSelectionData:function(a){return{selectedOption:this.scenario.db.get(c(a).data("id")),scene:this.outline,scenario:this.scenario.options.outline}},hideOptions:function(){this.sceneDOM.find(".responses").css("opacity",0)},syncElementPositions:function(){this.sceneDOM.find(".characterSpeech")[this.isResponded()?"addClass":"removeClass"]("top")},resize:function(){this.syncElementPositions();this.messageFeed.setSyncEl(this.getCharacterEl())},isActive:function(){return this.active},
destroy:function(){this.sceneDOM.remove();this.scenario.audioControls.haltPlayback()},isResponded:function(){return 768>c(window).width()+17||this.scenario.$el.hasClass("xs")},getCharacterEl:function(){return this.sceneDOM.find(".character "+(this.isResponded()?"img.face":"img.full"))}};d.Scene.Utility={checkHasAudio:function(a){return a.upload_id?!0:!1}};d.Scene.template=Handlebars.compile("\x3cdiv class\x3d'scene flex inline'"+(dkiUA.isIE()?'role\x3d"application"':"")+"\x3e{{#ifEq scenario.parameters.config.orientation 'left'}}\x3cdiv class\x3d'character'\x3e\x3cimg class\x3d'full' {{#if character}}src\x3d'{{character}}'{{/if}}/\x3e\x3cimg class\x3d'face' {{#if characterHeadshot}}src\x3d'{{characterHeadshot}}'{{/if}}/\x3e\x3c/div\x3e{{/ifEq}}\x3cdiv class\x3d'dialog flex flexCol'\x3e\x3cdiv class\x3d'feedCont flexAuto'\x3e\x3c/div\x3e\x3cul class\x3d'responses'\x3e{{#each scene.elements}}{{#if meta}}\x3cli role\x3d'button' tabindex\x3d'-1' aria-hidden\x3d'true' class\x3d'sceneOption speech {{../../scenario.parameters.config.userSpeechBubbleBg}} {{../../scenario.parameters.config.userSpeechBubbleCls}} top {{../../speechOrientation}}' data-id\x3d'{{id}}'\x3e{{{meta}}}\x3c/li\x3e{{/if}}{{/each}}\x3c/ul\x3e\x3c/div\x3e{{#ifEq scenario.parameters.config.orientation 'right'}}\x3cdiv class\x3d'character'\x3e\x3cimg class\x3d'full' {{#if character}}src\x3d'{{character}}'{{/if}}/\x3e\x3cimg class\x3d'face' {{#if characterHeadshot}}src\x3d'{{characterHeadshot}}'{{/if}}/\x3e\x3c/div\x3e{{/ifEq}}\x3c/div\x3e");
d.EndScene=function(a,b,c){this.template=d.EndScene.template;this.superclass=d.Scene;this.superclass.apply(this,arguments);this.scenario.setScore(a.parameters.config.weight||0);return this};d.EndScene.prototype=Object.create(d.Scene.prototype);d.EndScene.prototype.getRenderConfig=function(){var a=this.superclass.prototype.getRenderConfig.apply(this);a.audio=d.Scene.Utility.checkHasAudio(this.outline);a.audioLabel=this.scenario.options.strings.audioStop;return a};d.EndScene.prototype.start=function(a){this.active=
!0;this.sceneDOM.attr("aria-hidden","false");this.sceneDOM.addClass("interact");this.sceneDOM.find(".responses .speech, .responses .btn.btn-primary").attr(d.constant.screenReader.visible);this.runStartingAudio();(a||function(){})();this.sceneDOM.addClass("active");this.outline.parameters.config.link||(this.scenario.buildPath(this.outline),this.optionSelected(!1));this.scenario.options.accessible&&(a=this.sceneDOM.find(".responses *[tabindex\x3d1]").first()[0]||this.container.closest(".dki-authoring-element").find("*[tabindex\x3d1]").first()[0])&&
a.focus();return this};d.EndScene.prototype.optionSelected=function(a){var b=a&&c(a).data("link")?!1:!0;this.scenario.$el.trigger(b?"scenario.end":"scenario.continue",this.getSelectionData(a,b))};d.EndScene.prototype.getSelectionData=function(a,b){var d=this.superclass.prototype.getSelectionData.call(this,a);b?d.path=this.scenario.path:d.linkTo=this.scenario.db.getByKey("dragdrop_id",c(a).data("link"));return d};d.EndScene.prototype.resize=function(){};d.EndScene.template=Handlebars.compile("\x3cdiv class\x3d'scene endScene'"+
(dkiUA.isIE()?'role\x3d"application"':"")+"\x3e\x3cdiv class\x3d'disabler flex flexCol' style\x3d'opacity:1;'\x3e\x3cdiv class\x3d'preamble flex flexCol responses' style\x3d'margin:auto'\x3e\x3cdiv class\x3d'flex'\x3e{{#ifEq scenario.parameters.config.orientation 'left'}}\x3cimg class\x3d'face{{#if scene.meta}} noMargin{{/if}}' {{#if characterHeadshot}}src\x3d'{{characterHeadshot}}'{{/if}}/\x3e{{/ifEq}}{{#if scene.meta}}\x3cdiv data-id\x3d{{scenario.id}}' class\x3d'speech characterSpeech top {{scenario.parameters.config.characterSpeechBubbleBg}} {{scenario.parameters.config.characterSpeechBubbleCls}} {{scenario.parameters.config.orientation}}' style\x3d'float:none;'\x3e{{#if audio}}\x3cdiv class\x3d'audio'\x3e\x3cdiv tabindex\x3d'1' role\x3d'switch' aria-checked\x3d'true' aria-label\x3d'{{audioLabel}}' class\x3d'control fa fa-stop'\x3e\x3c/div\x3e\x3c/div\x3e{{/if}}\x3cspan tabindex\x3d'1'\x3e{{{scene.meta}}}\x3c/span\x3e\x3c/div\x3e{{/if}}{{#ifEq scenario.parameters.config.orientation 'right'}}\x3cimg class\x3d'face{{#if scene.meta}} noMargin{{/if}}' {{#if characterHeadshot}}src\x3d'{{characterHeadshot}}'{{/if}}/\x3e{{/ifEq}}\x3c/div\x3e{{#if scene.txt}}\x3cdiv role\x3d'region' tabindex\x3d'1' class\x3d'speech {{scenario.parameters.config.userSpeechBubbleBg}} endScene_txt'\x3e{{{scene.txt}}}\x3c/div\x3e{{/if}}{{#if scene.parameters.config.link}}\x3cbutton type\x3d'button' tabindex\x3d'-1' aria-hidden\x3d'true' class\x3d'sceneOption btn btn-primary' data-link\x3d'{{scene.parameters.config.link}}'\x3e\x3cspan\x3e{{strings.continue}}\x3c/span\x3e\x3c/button\x3e{{/if}}\x3c/div\x3e\x3c/div\x3e\x3c/div\x3e");
c.fn.Scenario=function(a){var b=a,e=Array.prototype.slice.call(arguments,1);return this.each(function(){var f=c(this),g=c(this).data("dki.Scenario");options=c.extend(!0,{},d.DEFAULTS,"object"===typeof b&&b);if("string"===typeof a&&!g)return!1;g?"string"===typeof a&&(f=c(this).data("dki.Scenario"))&&f[a]&&f[a].apply(c(this).data("dki.Scenario"),e):f.data("dki.Scenario",new d(this,options))})};c.fn.Scenario.Constructor=d;var e=function(a){this.options=c.extend(!0,{},e.DEFAULTS,"object"===typeof a&&
a);this.render();this.firstPosition=!0;this.positionFeed=DKI.func.debounce(c.proxy(this.runPosition,this),50,!1);return this};(function(){var a={transition:"transitionend",OTransition:"oTransitionEnd",MozTransition:"transitionend",WebkitTransition:"webkitTransitionEnd"};for(t in a)if(void 0!==c("html")[0].style[t]){e.transitionEvent=a[t];break}})();e.DEFAULTS={};e.prototype={render:function(){this.setDom(c("\x3cdiv class\x3d'messageFeed'\x3e\x3cdiv class\x3d'feed-content'\x3e\x3c/div\x3e\x3c/div\x3e"));
return this},setDom:function(a){this.$el=c(a);this.$feed=this.$el.find(".feed-content");return this.$el},attach:function(a,b){this.stop();a[b](this.setDom(this.$el.clone()))},add:function(a,b,c){b=b||function(){};a.uniqueId();this.$feed.append(a);a.wrap("\x3cdiv class\x3d'clearfix'"+(a.hasClass("characterSpeech")?" style\x3d'right:0;'":"")+"\x3e\x3c/div\x3e");a=a.parent();a.css({opacity:0,bottom:-100}).addClass("animate active");this.$el.css("min-height",a.outerHeight(!0));this.runAddAnimation(a,
b);this.firstPosition&&(this.firstPosition=!1);a.siblings().removeClass("active").find(".speech *[tabindex]").attr(d.constant.screenReader.hidden);a.addClass("active");return this},runPosition:function(){if(this.syncEl){var a=this.$feed.children().last(),a=Math.max(this.syncEl.position().top+.15*Math.min(this.syncEl.parent().outerHeight(),this.syncEl.outerHeight()),a?c(a).outerHeight(!0):0);this.$el.height(a)}},setSyncEl:function(a){this.syncEl=a;this.runPosition()},runAddAnimation:function(a,b){b=
b||function(){};a.find(".speech");this.animating={el:a,callback:b};this.$feed.css({"padding-bottom":a.outerHeight(!0)});d.Utility.onTransition(this.$feed,c.proxy(function(){this.$feed.addClass("noAnimate");a.css({opacity:1,bottom:0});d.Utility.onTransition(a,c.proxy(function(){this.$feed.css("padding-bottom",0);setTimeout(c.proxy(function(){this.$feed.removeClass("noAnimate")},this));a.removeClass("animate");this.animating=!1;b(a)},this))},this))},resize:function(){this.positionFeed()},stop:function(){this.animating&&
(d.Utility.transitionOff(this.animating.el),this.$feed.removeClass("noAnimate"),this.animating.el.removeClass("animate"),this.animating.callback(this.animating.el),this.animating=!1)},clear:function(){this.$feed.html("");this.firstPosition=!0;return this}};d.Utility={getElementOffset:function(a,b){return b.offset().top-a.offset().top},onTransition:function(a,b){if(!dkiUA||!dkiUA.ie||10<dkiUA.ieVersion){if(e.transitionEvent)return a.one(e.transitionEvent+".messageFeed",b),!1;if(c("html").hasClass("csstransforms"))return a.data("messageFeed-transition",
setTimeout(function(){b()},350)),!1}b()},transitionOff:function(a){e.transitionEvent?a.off(e.transitionEvent+".messageFeed"):c("html").hasClass("csstransforms")&&a.data("messageFeed-transition")&&(clearTimeout(a.data("messageFeed-transition")),a.data("messageFeed-transition",""))}}}(window.jQuery);